<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è Google ‚Äî –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</title>
<style>
  body {
    font-family: Consolas, monospace;
    background: #f6f6f6;
    padding: 20px;
  }
  #log {
    white-space: pre-wrap;
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }
</style>
</head>
<body>

<h2>Google OAuth Redirect Debug</h2>
<div id="log">–õ–æ–≥–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è...</div>

<script src="auth-google.js"></script>

<script>
  function log(msg) {
    console.log(msg);
    document.getElementById("log").textContent += msg + "\n";
  }

  log("=== PAGE LOADED ===");
  log("auth-google.js loaded? " + (typeof handleGoogleRedirect));

  async function debug() {
    log("Running debug()...");

    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    log("URL code: " + code);

    const codeVerifier = localStorage.getItem("google_code_verifier");
    log("localStorage code_verifier: " + codeVerifier);

    if (!code) {
      log("‚ùå ERROR: URL –Ω–µ –º—ñ—Å—Ç–∏—Ç—å ?code=");
      return;
    }

    if (!codeVerifier) {
      log("‚ùå ERROR: code_verifier –≤—ñ–¥—Å—É—Ç–Ω—ñ–π —É localStorage");
      alert("Code verifier missing! –ü–æ–≤—Ç–æ—Ä—ñ—Ç—å –ª–æ–≥—ñ–Ω.");
      return;
    }

    log("‚Üí –í–∏–∫–æ–Ω—É—î–º–æ Fetch —É n8n‚Ä¶");

    try {
      const res = await fetch("https://narodocnt.online/api/google-signup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          code,
          code_verifier: codeVerifier,
          redirect_uri: "https://narodocnt.online/oauth2callback.html"
        })
      });

      log("n8n status: " + res.status);

      const text = await res.text();
      log("n8n raw response:\n" + text);

      try {
        const json = JSON.parse(text);
        log("Parsed JSON OK");
        log(JSON.stringify(json, null, 2));
      } catch (e) {
        log("‚ùó JSON parse failed ‚Äî –≤—ñ–¥–ø–æ–≤—ñ–¥—å –±—É–ª–∞ –Ω–µ JSON");
      }

      if (!res.ok) {
        log("‚ùå FATAL: –ó–∞–ø–∏—Ç –Ω–µ —É—Å–ø—ñ—à–Ω–∏–π");
        alert("–ü–æ–º–∏–ª–∫–∞ –∑ n8n: " + text);
        return;
      }

      log("üéâ –£—Å–ø—ñ—Ö! –û—Ç—Ä–∏–º–∞–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å.");
      alert("Google Login Success!");

      localStorage.removeItem("google_code_verifier");
      window.history.replaceState({}, document.title, "/");

    } catch (err) {
      log("‚ùå FETCH ERROR:");
      log(err.toString());
      alert("Fetch error ‚Äî –¥–∏–≤–∏—Å—å –ª–æ–≥.");
    }
  }

  debug();
</script>

</body>
</html>
